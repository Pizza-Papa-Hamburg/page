<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reservierung ‚Äì Chat</title>
  <style>
    :root{
      --bg:#0f1115; --fg:#e8ecf1; --muted:#a9b2c0; --brand:#7aa2ff;
      --card:#171a21; --card2:#1c212b; --accent:#2a3240; --ok:#2ecc71; --bad:#e74c3c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui, Segoe UI, Roboto, Helvetica, Arial}
    a{color:var(--brand)}
    #app{max-width:820px;margin:0 auto;padding:20px}
    #view{display:block}
    .ppx-msg{margin:8px 0}
    .ppx-card{
      background:var(--card); border:1px solid var(--accent); border-radius:14px;
      padding:14px 16px; box-shadow:0 6px 24px rgba(0,0,0,.25)
    }
    .ppx-heading{margin:0 0 10px;font-size:18px}
    .ppx-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); margin:10px 0}
    .ppx-opt{
      background:var(--card2); border:1px solid var(--accent); border-radius:12px; padding:10px 12px;
      display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none
    }
    .ppx-opt[aria-pressed="true"], .ppx-opt.selected{outline:2px solid var(--brand)}
    .ppx-ico{width:22px; display:inline-flex; justify-content:center}
    .ppx-minirow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .ppx-mini{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      background:#10141b; border:1px solid var(--accent); border-radius:10px; cursor:pointer; user-select:none
    }
    .ppx-pill{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; margin:6px 8px 0 0;
      background:var(--card2); border:1px solid var(--accent); border-radius:999px; cursor:pointer
    }
    .ppx-actions{margin:10px 0 6px}
    .ppx-input input, .ppx-input textarea{
      width:100%; padding:10px 12px; border-radius:10px; background:#0e131a; border:1px solid var(--accent); color:var(--fg)
    }
    .ppx-input textarea{min-height:100px; resize:vertical}
    .ppx-appear{animation:fadein .22s ease-out both}
    @keyframes fadein{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}

    /* Floating widget */
    .ppx-launch{
      position:fixed; right:18px; bottom:18px; z-index:9998;
      display:flex; align-items:center; gap:8px; padding:10px 12px;
      border:1px solid var(--accent); border-radius:999px; background:var(--card2); cursor:pointer
    }
    .ppx-dot{width:22px;height:22px;border-radius:999px;display:grid;place-items:center;background:#fff;color:#111}
    .ppx-panel{
      position:fixed; right:18px; bottom:78px; width:420px; max-width:calc(100vw - 36px); max-height:70vh;
      border:1px solid var(--accent); border-radius:14px; background:var(--card); box-shadow:0 10px 40px rgba(0,0,0,.45);
      display:none; flex-direction:column; overflow:hidden; z-index:9999
    }
    .ppx-open{display:flex}
    .ppx-h{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--accent); background:var(--card2)}
    .ppx-title{font-weight:700}
    .ppx-x{background:transparent; color:var(--fg); border:1px solid var(--accent); border-radius:8px; padding:6px 10px; cursor:pointer}
    .ppx-v{flex:1; overflow:auto; padding:12px}
    .ppx-brandbar{padding:8px 12px;background:rgba(255,255,255,.92);color:#11231c;border-top:1px solid rgba(0,0,0,.08);font-size:12px;text-align:center}
  </style>
  <!-- EmailJS Browser SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
  <div id="app">
    <h1>Demo: Reservierungs-Chat</h1>
    <div id="view"></div>
  </div>

  <!-- Launcher -->
  <div class="ppx-launch" id="ppx-launch" role="button" aria-label="Schnellzugriff √∂ffnen">
    <div>Reservieren &amp; mehr ‚ú®</div><div class="ppx-dot">üí¨</div>
  </div>

  <!-- Panel -->
  <div class="ppx-panel" id="ppx-panel" aria-live="polite">
    <div class="ppx-h">
      <div class="ppx-title">Pizza Papa Hamburg</div>
      <button class="ppx-x" id="ppx-close" aria-label="Chat schlie√üen">√ó</button>
    </div>
    <div class="ppx-v" id="ppx-v"></div>
    <div class="ppx-brandbar">Powered by <strong>AI Elements</strong> ‚ú®</div>
  </div>

  <script>
  (function(){
    /* --------- INIT EMAILJS --------- */
    const PUBLIC_KEY = 'J1KTj7-7VJBsV-LHc';
    emailjs.init({ publicKey: PUBLIC_KEY });

    /* --------- CONFIG --------- */
    const CFG = {
      brand: "Pizza Papa Hamburg",
      phone: "+49 40 1234567",
      email: "pizza.papa.hamburg@outlook.de",
      address: "Muster Str. XX, YYYYY Musterstadt",
      hoursLines: [
        ["Mo. - Fr.","11 - 22 Uhr"],
        ["Sa.","13 - 24 Uhr"],
        ["So.","15 - 21 Uhr"],
      ],
      /* 0=So ‚Ä¶ 6=Sa */
      OPEN: {
        1:["11:00","22:00"], 2:["11:00","22:00"], 3:["11:00","22:00"],
        4:["11:00","22:00"], 5:["11:00","22:00"],
        6:["13:00","24:00"], 0:["15:00","21:00"]
      },
      BUCKETS: { mittag:["12:00","17:30"], frueh:["18:00","20:30"], spaet:["21:00","23:59"] },

      /* EmailJS IDs ‚Äì aus deiner Datei √ºbernommen */
      EMAIL:{
        service:"service_ais7v5f",
        toTemplate:"template_m5baprd",       // an Restaurant
        autoReplyTemplate:"template_hnwo39i" // an Gast
      }
    };

    /* --------- DOM & helpers --------- */
    const panel  = document.getElementById("ppx-panel");
    const launch = document.getElementById("ppx-launch");
    const close  = document.getElementById("ppx-close");
    const view   = document.getElementById("ppx-v");
    const stack=[]; let current=null;

    const el=(t,c,h)=>{const n=document.createElement(t);if(c)n.className=c;if(h!=null)n.innerHTML=h;return n;};
    const scroll=()=>view.scrollTop=view.scrollHeight;
    const reveal=(node)=>requestAnimationFrame(()=>{ try{ node.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){} });
    const esc=s=>String(s).replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const msg=h=>view.append(el("div","ppx-msg ppx-bot ppx-appear",h));
    const closeP=()=>panel.classList.remove("ppx-open");
    const reset=()=>{stack.length=0;current=null;view.innerHTML="";};
    const wait = (ms) => new Promise(r => setTimeout(r, ms));
    const DELAY = { short:350, medium:650, long:900, compact:450 };

    function actionsHome(){
      const row=el('div','ppx-actions ppx-appear');
      const bHome=el('div','ppx-pill','‚ü≤ Zum Anfang'); bHome.addEventListener('click',()=>show('root'));
      const bDone=el('div','ppx-pill','Fertig ‚úì'); bDone.addEventListener('click',done);
      row.append(bHome,bDone); view.append(row);
    }
    function actions(target="root", extras=[]){
      const row=el('div','ppx-actions ppx-appear');
      const bBack=el('div','ppx-pill','‚Üê Zur√ºck'); bBack.addEventListener('click',()=> target==='back'? back():show('root')); row.append(bBack);
      if(extras.includes('reserve')){ const bRes=el('div','ppx-pill','üìÖ Reservieren'); bRes.addEventListener('click',()=>show('reserve')); row.append(bRes); }
      if(extras.includes('contact')){ const bCon=el('div','ppx-pill','üìû Kontakt'); bCon.addEventListener('click',()=>show('contact')); row.append(bCon); }
      const bDone=el('div','ppx-pill','Fertig ‚úì'); bDone.addEventListener('click',done); row.append(bDone);
      view.append(row);
    }
    function done(){ msg('<div class="ppx-card">Danke dir ‚Äì bis zum n√§chsten Mal! üëã</div>'); scroll(); setTimeout(()=>{ closeP(); reset(); },900); }
    function back(){ if(stack.length<=1){show("root");return;} stack.pop(); const prev=stack.pop(); show(prev); }

    function selectInGroup(container, selector, target){
      container.querySelectorAll(selector).forEach(n=>{ n.classList.remove('ppx-selected'); n.setAttribute('aria-pressed','false'); });
      target.classList.add('ppx-selected'); target.setAttribute('aria-pressed','true');
    }
    function addHomeMini(container, resolve){
      const b=el('div','ppx-mini','‚ü≤ Zum Anfang');
      b.addEventListener('click',()=>resolve({__home:true}));
      container.appendChild(b);
    }
    function addBackMini(container, resolve, nodesToRemove = []){
      const b = el('div','ppx-mini','‚Üê Zur√ºck');
      b.addEventListener('click', ()=>{
        nodesToRemove.forEach(n => { try{ n.remove(); }catch(e){} });
        resolve({ __back:true });
      });
      container.appendChild(b);
    }
    const isHome = v => v && v.__home;
    const isBack = v => v && v.__back;

    const pad=n=>String(n).padStart(2,'0');
    const hmToMin = s => { const [h,m]=s.split(':').map(Number); return (h===24 && (m||0)===0) ? 24*60-1 : h*60+(m||0); };
    const minToHm = m => `${pad(Math.floor(m/60))}:${pad(m%60)}`;
    const clampRange = (start,end, cStart,cEnd) => [Math.max(start,cStart), Math.min(end,cEnd)];
    const fmtDate = d => `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
    const twoHoursFromNow = () => new Date(Date.now()+2*60*60*1000);

    function slotsForDay(date, bucketKey){
      const dow=date.getDay(); // 0=So
      const open=CFG.OPEN[dow]; if(!open) return [];
      const [oS,oE]=open.map(hmToMin);
      const [bS0,bE0]=CFG.BUCKETS[bucketKey];
      const [bS,bE]=[hmToMin(bS0), hmToMin(bE0)];
      let [s,e]=clampRange(bS,bE,oS,oE);
      if(e - s < 30) return [];
      const out=[]; const now2=twoHoursFromNow();
      const sameDay=(a,b)=>a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();
      for(let m=s; m<=e; m+=30){
        const slot=new Date(date); slot.setHours(Math.floor(m/60), m%60, 0, 0);
        if(!sameDay(slot,new Date()) || slot.getTime()>=now2.getTime()){ out.push(minToHm(m)); }
      }
      return out;
    }

    /* --------- Nodes --------- */
    const NODES={
      root(){
        msg(`<div class="ppx-heading">üëã Willkommen bei ${esc(CFG.brand)}!</div><div>Sch√∂n, dass du da bist. Wie k√∂nnen wir dir heute helfen?</div>`);
        const grid=el("div","ppx-grid ppx-appear");
        [
          {label:"Speisen",id:"menu",icon:"üçΩ"},
          {label:"Reservieren",id:"reserve",icon:"üìÖ"},
          {label:"√ñffnungszeiten",id:"hours",icon:"üïí"},
          {label:"Kontaktdaten",id:"contact",icon:"üìû"},
          {label:"Q&As",id:"qas",icon:"‚ùì"}
        ].forEach(o=>{
          const b=el("div","ppx-opt",`<span class="ppx-ico">${o.icon}</span><span>${o.label}</span>`);
          b.addEventListener("click",()=>show(o.id)); grid.appendChild(b);
        });
        view.append(grid); scroll();
      },
      menu: async function(){
        msg("Super Wahl üëç Hier sind unsere Speisen-Kategorien:"); scroll(); await wait(DELAY.medium);
        const box=el('div','ppx-card ppx-appear',`<h4 class="ppx-heading">Speisen</h4><div style="margin-top:6px">‚Ä¶oder w√§hle eine Kategorie:</div>`); view.append(box);
        const grid=el("div","ppx-grid ppx-appear"); view.append(grid);
        [{id:"pizza",label:"Pizza"},{id:"pasta",label:"Pasta"},{id:"salads",label:"Salate"}].forEach(cat=>{
          const b=el("div","ppx-opt",`<span class="ppx-ico">‚û§</span><span>${cat.label}</span>`); b.addEventListener("click",()=>show("cat:"+cat.id)); grid.appendChild(b);
        });
        await wait(50); actions('root',['reserve']); scroll();
      },
      hours: async function(){
        msg("Kein Problem ‚Äì ich zeig dir kurz unsere Zeiten:"); scroll(); await wait(DELAY.medium);
        const box=el('div','ppx-card ppx-appear'); box.innerHTML=`<h4 class="ppx-heading">√ñffnungszeiten</h4>
          <div class="ppx-hours">${CFG.hoursLines.map(r=>`<div>${esc(r[0])}:</div><div>${esc(r[1])}</div>`).join('')}</div>`;
        view.append(box); await wait(50); actions('root',['reserve']); scroll();
      },
      contact: async function(){
        msg("Hier findest du alle Kontaktdaten ‚Äì melde dich jederzeit gern:"); scroll(); await wait(DELAY.medium);
        const box=el('div','ppx-card ppx-appear'); box.innerHTML=`<h4 class="ppx-heading">Kontaktdaten</h4>
          <div>Adresse: ${esc(CFG.address)}</div>
          <div>Telefon: <a class="ppx-link" href="tel:${esc(CFG.phone).replace(/\s/g,'')}">${esc(CFG.phone)}</a></div>
          <div>E-Mail: <a class="ppx-link" href="mailto:${esc(CFG.email)}">${esc(CFG.email)}</a></div>`;
        view.append(box); await wait(50); actions('root'); scroll();
      },
      qas: async function(){
        msg("Alles klar! Hier sind h√§ufige Fragen & Antworten:"); scroll(); await wait(DELAY.medium);
        const box=el('div','ppx-card ppx-appear'); box.innerHTML=`<h4 class="ppx-heading">Q&As</h4>
          <div>FAQ als PDF: <a class="ppx-link" target="_blank" rel="noopener" href="#">√∂ffnen</a></div>`;
        view.append(box); await wait(50); actions('root',['contact']); scroll();
      },
      reserve: async function(){ await flowStart(); }
    };

    /* --------- Ask helpers (mit Zur√ºck + Auto-Scroll) --------- */
    function askDate(minDate){
      view.querySelectorAll('.ppx-card[data-step="date"]').forEach(n=>n.remove());
      const box=el('div','ppx-card ppx-appear'); box.dataset.step='date';
      const minAttr=`${minDate.getFullYear()}-${String(minDate.getMonth()+1).padStart(2,'0')}-${String(minDate.getDate()).padStart(2,'0')}`;
      box.innerHTML=`<h4 class="ppx-heading">Datum w√§hlen</h4>
        <div class="ppx-input"><input id="ppx-date" type="date" min="${minAttr}"></div>
        <div class="ppx-minirow"><div class="ppx-mini" id="ppx-date-ok">Weiter ‚Üí</div></div>`;
      view.append(box); scroll();
      return new Promise(res=>{
        const row=box.querySelector('.ppx-minirow');
        addBackMini(row,res,[box]);
        addHomeMini(row,res);
        box.querySelector('#ppx-date-ok').addEventListener('click',()=>{
          const v=box.querySelector('#ppx-date').value; if(!v){ alert('Bitte w√§hle ein Datum.'); return; }
          const [y,m,d]=v.split('-').map(Number); res(new Date(y,m-1,d));
        });
      });
    }

    function askBucket(date){
      view.querySelectorAll('.ppx-card[data-step="bucket"]').forEach(n=>n.remove());
      const box=el('div','ppx-card ppx-appear'); box.dataset.step='bucket';
      box.innerHTML=`<h4 class="ppx-heading">Tageszeit w√§hlen</h4>
        <div class="ppx-grid">
          <div class="ppx-opt" data-k="mittag" role="button" aria-pressed="false"><span class="ppx-ico">‚òÄÔ∏è</span><span>Mittag</span></div>
          <div class="ppx-opt" data-k="frueh"  role="button" aria-pressed="false"><span class="ppx-ico">üåÜ</span><span>Fr√ºher Abend</span></div>
          <div class="ppx-opt" data-k="spaet"  role="button" aria-pressed="false"><span class="ppx-ico">üåô</span><span>Sp√§ter Abend</span></div>
        </div>
        <div class="ppx-minirow"></div>`;
      view.append(box); scroll();

      const grid=box.querySelector('.ppx-grid'); const mini=box.querySelector('.ppx-minirow');
      return new Promise(res=>{
        addBackMini(mini,res,[box]);
        addHomeMini(mini,res);
        grid.querySelectorAll('.ppx-opt').forEach(b=>{
          b.addEventListener('click',()=>{ selectInGroup(grid,'.ppx-opt',b); setTimeout(()=>res(b.dataset.k),120); });
        });
      });
    }

    function askTime(date,bucket){
      view.querySelectorAll('[data-step="time"]').forEach(n=>n.remove());
      const slots=slotsForDay(date,bucket);
      const wrap=el('div','ppx-card ppx-appear'); wrap.dataset.step='time';
      view.append(wrap);

      if(slots.length===0){
        wrap.innerHTML=`<h4 class="ppx-heading">Uhrzeit</h4>
          <div>F√ºr diese Tageszeit gibt es heute leider keine Slots.</div>
          <div class="ppx-minirow"></div>`;
        const mini=wrap.querySelector('.ppx-minirow');
        reveal(wrap);
        return new Promise(res=>{
          addBackMini(mini,res,[wrap]);
          addHomeMini(mini,res);
        });
      }

      wrap.innerHTML=`<h4 class="ppx-heading">Uhrzeit w√§hlen</h4>`;
      const grid=el('div','ppx-grid ppx-appear'); grid.dataset.step='time';
      const mini=el('div','ppx-minirow'); mini.dataset.step='time';
      view.append(grid,mini); scroll(); reveal(wrap);

      return new Promise(res=>{
        addBackMini(mini,res,[wrap,grid,mini]);
        addHomeMini(mini,res);
        slots.forEach(t=>{
          const b=el('div','ppx-opt',`<span class="ppx-ico">üïí</span><span>${t} Uhr</span>`);
          b.setAttribute('role','button'); b.setAttribute('aria-pressed','false');
          b.addEventListener('click',()=>{ selectInGroup(grid,'.ppx-opt',b); setTimeout(()=>res(t),120); });
          grid.appendChild(b);
        });
      });
    }

    function askNumber(label,min=1){
      view.querySelectorAll('.ppx-card[data-step="persons"]').forEach(n=>n.remove());
      const box=el('div','ppx-card ppx-appear'); box.dataset.step='persons';
      box.innerHTML=`<h4 class="ppx-heading">${esc(label)}</h4>
        <div class="ppx-input"><input id="ppx-num" type="number" min="${min}" value="${min}" placeholder="Zahl eingeben‚Ä¶"></div>
        <div class="ppx-minirow"><div class="ppx-mini" id="ppx-num-ok">Weiter ‚Üí</div></div>`;
      view.append(box); scroll();
      return new Promise(res=>{
        const row=box.querySelector('.ppx-minirow');
        addBackMini(row,res,[box]);
        addHomeMini(row,res);
        box.querySelector('#ppx-num-ok').addEventListener('click',()=>{
          const v=Number(box.querySelector('#ppx-num').value); if(!Number.isFinite(v) || v<min){ alert('Bitte nenne eine Zahl.'); return; } res(v);
        });
      });
    }

    function askText(label, placeholder="Eingeben‚Ä¶"){
      view.querySelectorAll('.ppx-card[data-step="name"]').forEach(n=>n.remove());
      const box=el('div','ppx-card ppx-appear'); box.dataset.step='name';
      box.innerHTML=`<h4 class="ppx-heading">${esc(label)}</h4>
        <div class="ppx-input"><input id="ppx-txt" type="text" placeholder="${esc(placeholder)}"></div>
        <div class="ppx-minirow"><div class="ppx-mini" id="ppx-txt-ok">Weiter ‚Üí</div></div>`;
      view.append(box); scroll();
      return new Promise(res=>{
        const row=box.querySelector('.ppx-minirow');
        addBackMini(row,res,[box]);
        addHomeMini(row,res);
        box.querySelector('#ppx-txt-ok').addEventListener('click',()=>{
          const v=box.querySelector('#ppx-txt').value.trim(); if(!v){ alert('Bitte ausf√ºllen.'); return; } res(v);
        });
      });
    }

    function askPhone(){
      view.querySelectorAll('.ppx-card[data-step="phone"]').forEach(n=>n.remove());
      const box=el('div','ppx-card ppx-appear'); box.dataset.step='phone';
      box.innerHTML=`<h4 class="ppx-heading">Telefonnummer (optional)</h4>
        <div class="ppx-input"><input id="ppx-phone" type="tel" placeholder="+49 ‚Ä¶"></div>
        <div class="ppx-minirow">
          <div class="ppx-mini" id="ppx-phone-ok">Weiter ‚Üí</div>
          <div class="ppx-mini" id="ppx-phone-skip">Ohne Telefon weiter</div>
        </div>`;
      view.append(box); scroll();
      const valid = v => /^[+()\s\-0-9]{6,}$/.test(v||"");
      return new Promise(res=>{
        const row=box.querySelector('.ppx-minirow');
        addBackMini(row,res,[box]);
        addHomeMini(row,res);
        box.querySelector('#ppx-phone-ok').addEventListener('click',()=>{
          const v=box.querySelector('#ppx-phone').value.trim(); if(!valid(v)){ alert('Bitte g√ºltige Nummer oder ‚ÄûOhne Telefon weiter‚Äú.'); return; } res(v);
        });
        box.querySelector('#ppx-phone-skip').addEventListener('click',()=>res(""));
      });
    }

    function askEmail(){
      view.querySelectorAll('.ppx-card[data-step="email"]').forEach(n=>n.remove());
      const box=el('div','ppx-card ppx-appear'); box.dataset.step='email';
      box.innerHTML=`<h4 class="ppx-heading">E-Mail f√ºr die Best√§tigung</h4>
        <div class="ppx-input"><input id="ppx-mail" type="email" placeholder="name@example.com"></div>
        <div class="ppx-minirow"><div class="ppx-mini" id="ppx-mail-ok">Weiter ‚Üí</div></div>`;
      view.append(box); scroll();
      const valid = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||"");
      return new Promise(res=>{
        const row=box.querySelector('.ppx-minirow');
        addBackMini(row,res,[box]);
        addHomeMini(row,res);
        box.querySelector('#ppx-mail-ok').addEventListener('click',()=>{
          const v=box.querySelector('#ppx-mail').value.trim(); if(!valid(v)){ alert('Bitte gib eine g√ºltige E-Mail an.'); return; } res(v);
        });
      });
    }

    function askTextarea(label, ph="Optional‚Ä¶"){
      view.querySelectorAll('.ppx-card[data-step="wishes"]').forEach(n=>n.remove());
      const box=el('div','ppx-card ppx-appear'); box.dataset.step='wishes';
      box.innerHTML=`<h4 class="ppx-heading">${esc(label)}</h4>
        <div class="ppx-input"><textarea id="ppx-area" placeholder="${esc(ph)}"></textarea></div>
        <div class="ppx-minirow"><div class="ppx-mini" id="ppx-area-ok">Weiter ‚Üí</div></div>`;
      view.append(box); scroll();
      return new Promise(res=>{
        const row=box.querySelector('.ppx-minirow');
        addBackMini(row,res,[box]);
        addHomeMini(row,res);
        box.querySelector('#ppx-area-ok').addEventListener('click',()=>res(box.querySelector('#ppx-area').value.trim()));
      });
    }

    /* --------- Flow (mit echtem Zur√ºck zwischen allen Steps) --------- */
    async function flowStart(){
      view.innerHTML="";
      msg("Perfekt ‚Äì lass uns einen Tisch f√ºr dich klarmachen:"); scroll(); await wait(DELAY.medium);

      const today = new Date();
      let i=0, date, bucket, time, persons, name, phone, email, wishes;

      while(true){
        if(i===0){
          const s = await askDate(today);
          if(isHome(s)) return show('root');
          if(isBack(s)) return show('root');
          date = s; i = 1; continue;
        }
        if(i===1){
          const s = await askBucket(date);
          if(isHome(s)) return show('root');
          if(isBack(s)) { i = 0; continue; }
          bucket = s; i = 2; continue;
        }
        if(i===2){
          const s = await askTime(date,bucket);
          if(isHome(s) || !s) return show('root');
          if(isBack(s)) { i = 1; continue; }
          time = s; i = 3; continue;
        }
        if(i===3){
          const s = await askNumber("Wie viele Personen?");
          if(isHome(s)) return show('root');
          if(isBack(s)) { i = 2; continue; }
          persons = s; i = 4; continue;
        }
        if(i===4){
          const s = await askText("Dein Name","Vor- und Nachname");
          if(isHome(s)) return show('root');
          if(isBack(s)) { i = 3; continue; }
          name = s; i = 5; continue;
        }
        if(i===5){
          const s = await askPhone();
          if(isHome(s)) return show('root');
          if(isBack(s)) { i = 4; continue; }
          phone = s; i = 6; continue;
        }
        if(i===6){
          const s = await askEmail();
          if(isHome(s)) return show('root');
          if(isBack(s)) { i = 5; continue; }
          email = s; i = 7; continue;
        }
        if(i===7){
          const s = await askTextarea("Sonstige W√ºnsche (optional)","Kinderstuhl, Allergien, Anlass ‚Ä¶");
          if(isHome(s)) return show('root');
          if(isBack(s)) { i = 6; continue; }
          wishes = s; i = 8; continue;
        }

        if(i===8){
          const dateStr = fmtDate(date);
          const summary=el('div','ppx-card ppx-appear',`
            <h4 class="ppx-heading">Zusammenfassung</h4>
            <div><strong>Datum:</strong> ${esc(dateStr)}</div>
            <div><strong>Uhrzeit:</strong> ${esc(time)} Uhr</div>
            <div><strong>Personen:</strong> ${esc(persons)}</div>
            <div><strong>Name:</strong> ${esc(name)}</div>
            <div><strong>Telefon:</strong> ${esc(phone||'‚Äì')}</div>
            <div><strong>E-Mail:</strong> ${esc(email)}</div>
            ${wishes?`<div><strong>W√ºnsche:</strong> ${esc(wishes)}</div>`:''}
          `);
          view.append(summary);

          const controls=el('div','ppx-actions ppx-appear');
          const bHome=el('div','ppx-pill','‚ü≤ Zum Anfang'); bHome.addEventListener('click',()=>show('root'));
          const bEdit=el('div','ppx-pill','‚Üê √Ñndern'); bEdit.addEventListener('click',flowStart);
          const bSend=el('div','ppx-pill','‚úâÔ∏è Anfrage senden');
          controls.append(bHome,bEdit,bSend); view.append(controls); scroll();

          function showErr(err){
            const t=(err?.text||err?.message||JSON.stringify(err)).slice(0,400)
              .replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]));
            msg(`<div class="ppx-card">Fehler von EmailJS:<br><small>${t}</small><br>
                 <div style="margin-top:6px">Tipp: EmailJS ‚Üí Account ‚Üí Security ‚Üí Allowed origins (<code>${location.origin}</code> zulassen).</div></div>`);
            scroll();
          }

          bSend.addEventListener('click', async () => {
            bSend.textContent = "Sende‚Ä¶"; bSend.style.pointerEvents = 'none';

            const tplBase = {
              date: dateStr, time: `${time} Uhr`, persons: String(persons),
              name, phone: phone || 'keine Angabe', email, message: wishes || ''
            };

            try {
              // 1) an Restaurant
              const tplToRestaurant = { ...tplBase, reply_to: email };
              await emailjs.send(CFG.EMAIL.service, CFG.EMAIL.toTemplate, tplToRestaurant);

              msg('<div class="ppx-card">Super. Du kannst jetzt in deinem E-Mail Postfach nachschauen! üìß</div>');
              scroll(); await wait(DELAY.short);
              msg('<div class="ppx-card">Hast du sonst noch Fragen?</div>');
              actionsHome(); scroll();

              // 2) Auto-Reply an Gast (Fehler nur loggen)
              const tplToGuest = { ...tplBase, to_email: email, reply_to: CFG.email };
              try { await emailjs.send(CFG.EMAIL.service, CFG.EMAIL.autoReplyTemplate, tplToGuest); } catch(e){ console.warn(e); }
            } catch (err) {
              console.error('EmailJS Error:', err);
              showErr(err);
              msg('<div class="ppx-card">Ups ‚Äì das hat leider nicht geklappt. Bitte versuch es sp√§ter erneut oder nutze <a class="ppx-link" href="mailto:'+esc(CFG.email)+'">E-Mail</a>.</div>');
              actionsHome(); scroll();
            }

            bSend.textContent = "‚úâÔ∏è Anfrage senden";
            bSend.style.pointerEvents = '';
          });

          return; // Flow fertig
        }
      }
    }

    /* --------- Router --------- */
    function show(id){
      current=id; if((stack.at(-1)!==id)) stack.push(id);
      if(id==="root"){ view.innerHTML=''; return NODES.root(); }
      if(id==="hours")   return NODES.hours();
      if(id==="contact") return NODES.contact();
      if(id==="menu")    return NODES.menu();
      if(id==="qas")     return NODES.qas();
      if(id==="reserve") return NODES.reserve();
      if(id.startsWith("cat:"))  return msg('<div class="ppx-card">Kategorien-Demo</div>');
    }
    function start(){ if(!current){ show("root"); } }

    launch.addEventListener("click", ()=>{ panel.classList.add("ppx-open"); if(!current) start(); });
    close.addEventListener("click", ()=>{ panel.classList.remove("ppx-open"); stack.length=0; current=null; view.innerHTML=""; });
  })();
  </script>
</body>
</html>
